<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="promise-import.html">

<!--
The base element for other google analytics elements. This element is not
intended to be used by itself. It is only intended to be subclassed.

@element google-analytics-base
@blurb Base element for other google analytics elements
@status alpha
@homepage http://polymerlabs.github.io/google-analytics
-->

<polymer-element name="google-analytics-base">
  <template>
    <google-api-loader
      name="analytics"
      version="v3">
    </google-api-loader>
  </template>

  <script>

    (function() {

      var isLoaded = false;
      var isAuthorized = false;

      /**
       * A promise that is resolved when the underlying client libraries are
       * loaded. It is rejected if there are any load errors.
       */
      var loadPromise = new Promise(function(resolve, reject) {
        document.addEventListener('google-api-load', function fn(event) {
          var lib = event.detail;
          if (lib.name == 'analytics' && lib.version == 'v3') {
            isLoaded = true;
            resolve(event.detail);
            document.removeEventListener('google-api-load', fn);
          }
        });
        document.addEventListener('google-api-load-error', function fn(event) {
          var lib = event.detail;
          if (lib.name == 'analytics' && lib.version == 'v3') {
            reject(event.detail.error);
            document.removeEventListener('google-api-load-error', fn);
          }
        });
      });

      // Log any errors loading the client library.
      loadPromise.catch(function(err) {
        console.error(err.stack || err);
      })


      Polymer('google-analytics-base', {

        /**
         * The `isLoaded` attribute is true when the underlying analytics
         * library is fully loaded.
         *
         * @attribute isLoaded
         * @type boolean
         */
        get isLoaded() {
          return isLoaded;
        },

        /**
         * The `isAuthorized` attribute is true once the user successfully
         * signs in <em>and</em> the libraries have been loaded. If the user
         * signs out this will be false.
         *
         * @attribute isAuthorized
         * @type boolean
         */
        get isAuthorized() {
          return isAuthorized;
        },

        created: function() {
          document.addEventListener('google-signin-success', function(event) {
            isAuthorized = true;
            loadPromise.then(this.authorized.bind(this, event.detail.result));
          }.bind(this));
          document.addEventListener('google-signed-out', function(event) {
            isAuthorized = false;
            this.unauthorized();
          }.bind(this));
        },

        /**
         * The `authorized` method will be invoked when the user has
         * successfully signed in and all the underlying client libraries
         * have been loaded.
         *
         * @method authorized
         * @param {Object} data - The auth data information.
         */
        authorized: function(data) {
          // Override in a subclass.
        },

        /**
         * The `unauthorized` method will be invoked when the user has
         * successfully signed out.
         *
         * @method unauthorized
         */
        unauthorized: function() {
          // Override in a subclass.
        }

      });

    }());

  </script>

</polymer-element>
